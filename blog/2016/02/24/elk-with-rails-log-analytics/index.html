<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="keywords" content="["Rails", "Server", "Log", "ELK", "Logstash", "ElasticSearch", "Kibana", "Docker"]">
    <meta name="description" content="王永志(Ryan Wang)的个人博客，关注Web，移动，产品，创业。">
    <meta name="baidu-site-verification" content="whKGC9t0PW" />
    <title>ELK 套件分析Rails日志 - 王永志的独立博客</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />

    <link href="../../../../../stylesheets/all-6c32d234.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <!--[if lt IE 7]>
      <p class="browsehappy">你的浏览器版本过于<strong>陈旧</strong>。请<a href="http://browsehappy.com/">更新你的浏览器</a> 以提升访问体验。</p>
    <![endif]-->
    <header class="navbar navbar-default" role="navigation">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">王永志的独立博客</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li><a href="/blog/archives">归档</a></li>
            <li><a href="/blog/topics/技术">技术</a></li>
            <li><a href="/blog/topics/运营">运营</a></li>
          </ul>
          <form class="navbar-form navbar-left" role="search" action='http://www.google.com.hk/search' id="search">
            <div class="form-group">
              <input type="hidden" name='sitesearch' value='wongyouth.com'>
              <input type="text" name='q' class="form-control" placeholder='搜索'>
            </div>
          </form>
        </div><!-- /.navbar-collapse -->

      </div><!-- /.container -->
    </header>

    <div class="container">
      <div class="row">
        <div id="main" role="main" class="col-sm-8 col-md-9">
            <article><section class="post"><h1 class="post-title"><i class="glyphicon glyphicon-info-sign"></i>ELK 套件分析Rails日志</h1><div class="meta text-muted">
  <div class="date">
    <i class="glyphicon glyphicon-calendar"></i>
    <abbr class="timeago" title="2016-02-24T14:36:00+08:00">2016-02-24 14:36</abbr>
  </div>
  <div class="comments">
    <i class="glyphicon glyphicon-comment"></i>
    <span class="ds-thread-count" data-thread-key="/blog/2016/02/24/elk-with-rails-log-analytics/" data-count-type="comments"></span>
  </div>
  <div class="tags">
    <i class="glyphicon glyphicon-tags"></i>
    <a href="/blog/tags/logstash/">Logstash</a>
  </div>
</div>

<div class="post-content"><p>当系统访问很频繁，服务器日志增多到一定量时，仅靠 <code>tail -f</code> 已经很难分析出有用信息了。
可能就只能进行一些简单的排除工作，比如根据日志内的时间信息，查找该时间附近有什么特殊访问之类。</p>

<p>即使这样用有时候也会比较麻烦，因为当你的应用服务器增多时，每个服务器都是单独写到本机日志文件内，造成了分析日志的难度。
这个时候就很需要一个工具来收集各个服务器日志来统一处理。</p>

<p>今天说的就是有关于这个问题的解法。</p>



<p>日志收集的工具也有不少 <a href="https://flume.apache.org/">Flume</a>，<a href="http://storm.apache.org/">storm</a>。 今天说的是 <a href="https://www.elastic.co/webinars/introduction-elk-stack">ELK stack</a> 这个套件。这个套件由 3 个部分组成：</p>

<ul>
<li><a href="https://www.elastic.co/products/elasticsearch">ElasticSearch</a></li>
<li><a href="https://www.elastic.co/products/logstash">Logstash</a></li>
<li><a href="https://www.elastic.co/products/kibana">Kibana</a></li>
</ul>

<p>简单地说: <code>Logstash</code> 用来收集数据；<code>ElasticSearch</code> 存储数据；<code>Kibana</code> 是表现层，Web 接口用来对接用户UI。</p>

<h3>ElasticSearch</h3>

<p>相信 <code>ElasticSearch</code> 大家可能听说的，是做全文搜索的，跟 <code>Solr</code> 差不多是基于 <code>Lucene</code> 来做的。他有几个特点：</p>

<ul>
<li>RESTful Web 接口</li>
<li>API 数据基于 JSON</li>
<li>分布式架构</li>
</ul>

<p>当然 <code>Solr</code> 现在也可以放到多台服务器上组成集群了，但是 <code>ElasticSearch</code> 从一开始就是这么设计的，这种与生俱来的特性与后天修补出来的体验是否一样，你懂得。</p>

<p><code>ElasticSearch</code> 在 <code>ELK</code> 套件中处于数据存储的身份，无疑是最核心的。</p>

<h3>Logstash</h3>

<p><code>Logstash</code> 可以单独使用，比如把各个服务器的日志收集起来集成到一个日志文件内，这样只要看一个日志文件，就不需要费力到每个服务器查看日志了。
当然结合今天介绍的套件使用无疑是最强大的。</p>

<p><code>Logstash</code> 作为输入接口，他有很多插件可用，对接文件，对接网络接口，甚至对接 ElasticSearch 作为输入。
比如在我们的例子中，要收集多台日志文件，Logstash 可以开 TCP 端口，各个日志服务器使用 <a href="https://www.elastic.co/downloads/beats/filebeat">filebeat</a> 代理来检查日志输出，一旦有新的日志输出到文件，
<code>filebeat</code> 就会把该内容发送到 <code>Logstash</code> 配置的端口内，这样就完成了日志的收集工作。</p>

<p><code>Logstash</code> 在收集了日志后，还可以对数据进行 分析，拆解成多个字段，再输出到 <code>ElasticSearch</code> 中，这样就能使用 <code>ElasticSearch</code> 强大的功能对这些字段进行搜索了。</p>

<h3>Kibana</h3>

<p><code>Kibana</code> 作为最后的用户 UI 接口，支持了很多分析的功能。比如分析每天的PV情况，一天内访问的高峰与低谷，异常攻击情况，瓶颈的处理等。</p>

<p><img alt="Kibana截图" src="images/blog/kibana-3d23475b.png" /></p>

<h2>实际应用</h2>

<p>下面是配置的 Rails4 日志的分析结构</p>

<p><figure class='code'><figcaption><span>logstash-pattern-rails4.conf</span> <a href='/downloads/code/logstash-pattern-rails4.conf'>源码</a></figcaption></p>
<pre class="highlight conf"><code><span class="c"># Rails4 log prefix
</span><span class="n">LOGLEVELSINGLE</span> %{<span class="n">WORD</span>}
<span class="n">PROCESSNUM</span> %{<span class="n">NUMBER</span>}
<span class="n">RAILS4PREFIX</span> %{<span class="n">LOGLEVELSINGLE</span>}, \[%{<span class="n">TIMESTAMP_ISO8601</span>} <span class="c">#%{PROCESSNUM}]  %{LOGLEVEL} -- : 
</span>
<span class="c"># This will often be the only line:
</span><span class="n">URIPATHPARAM2</span> %{<span class="n">URIPATH</span>:<span class="n">uripath</span>}(?:%{<span class="n">URIPARAM</span>})?
<span class="n">RAILS4HEAD</span> (?<span class="n">m</span>)%{<span class="n">RAILS4PREFIX</span>}<span class="n">Started</span> %{<span class="n">WORD</span>:<span class="n">verb</span>} <span class="s2">"%{URIPATHPARAM2:request}"</span> <span class="n">for</span> %{<span class="n">IPORHOST</span>:<span class="n">clientip</span>} <span class="n">at</span> (?&lt;<span class="n">timestamp</span>&gt;%{<span class="n">YEAR</span>}-%{<span class="n">MONTHNUM</span>}-%{<span class="n">MONTHDAY</span>} %{<span class="n">HOUR</span>}:%{<span class="n">MINUTE</span>}:%{<span class="n">SECOND</span>} %{<span class="n">ISO8601_TIMEZONE</span>})

<span class="c"># Output schema migration info right after started
</span><span class="n">RAILS4SCHEMAMIGRATION</span> \<span class="n">W</span>*%{<span class="n">RAILS4PREFIX</span>}<span class="n">ActiveRecord</span>::<span class="n">SchemaMigration</span> <span class="n">Load</span> \(%{<span class="n">NUMBER</span>:<span class="n">schemams</span>}<span class="n">ms</span>\)  <span class="n">SELECT</span> <span class="s2">"schema_migrations"</span>.* <span class="n">FROM</span> <span class="s2">"schema_migrations"</span>
<span class="c"># For some strange reason, params are stripped of {} - not sure that's a good idea.
</span><span class="n">RAILS4PARAMETERS</span> \<span class="n">W</span>*%{<span class="n">RAILS4PREFIX</span>}  <span class="n">Parameters</span>: {%{<span class="n">DATA</span>:<span class="n">params</span>}}
<span class="n">RAILS4RPROCESSING</span> (?:%{<span class="n">RAILS4SCHEMAMIGRATION</span>})?\<span class="n">W</span>*%{<span class="n">RAILS4PREFIX</span>}<span class="n">Processing</span> <span class="n">by</span> %{<span class="n">RCONTROLLER</span>} <span class="n">as</span> (?&lt;<span class="n">format</span>&gt;\<span class="n">S</span>+)(?:%{<span class="n">RAILS4PARAMETERS</span>})?

<span class="n">RAILS4PROFILE</span> (?:\(<span class="n">Views</span>: %{<span class="n">NUMBER</span>:<span class="n">viewms</span>:<span class="n">float</span>}<span class="n">ms</span> \| <span class="n">ActiveRecord</span>: %{<span class="n">NUMBER</span>:<span class="n">activerecordms</span>:<span class="n">float</span>}<span class="n">ms</span>|\(<span class="n">ActiveRecord</span>: %{<span class="n">NUMBER</span>:<span class="n">activerecordms</span>:<span class="n">float</span>}<span class="n">ms</span>)?
<span class="n">RAILS4FOOT</span> %{<span class="n">RAILS4PREFIX</span>}<span class="n">Completed</span> %{<span class="n">NUMBER</span>:<span class="n">response</span>} %{<span class="n">DATA</span>} <span class="n">in</span> %{<span class="n">NUMBER</span>:<span class="n">totalms</span>:<span class="n">int</span>}<span class="n">ms</span> %{<span class="n">RAILS4PROFILE</span>}%{<span class="n">GREEDYDATA</span>}

<span class="c"># Put it all together
</span><span class="n">RAILS4</span> %{<span class="n">RAILS4HEAD</span>}(?:%{<span class="n">RAILS4RPROCESSING</span>})?(?&lt;<span class="n">context</span>&gt;(?:%{<span class="n">DATA</span>}\<span class="n">n</span>)*)(?:%{<span class="n">RAILS4FOOT</span>})?

</code></pre>

<p></firgure></p>

<p>补充要说的是，时间戳默认是以 <code>Logstash</code> 收到的日志数据的系统时间为每条日志时间戳的，这与时间日志发生的时间并不一致，
需要抽出日志内容里的时间为日志时间戳，这个需要在以下的处理：</p>
<pre class="highlight plaintext"><code>data {
  match =&gt; ["timestamp", 'yyyy-MM-dd HH:mm:ss Z']
  remove_field =&gt; ['timestamp'] # 删除原来的时间戳
}
</code></pre>

<p>完整的<code>Logstash</code> 配置文件例子</p>

<p><figure class='code'><figcaption><span>logstash.conf</span> <a href='/downloads/code/logstash.conf'>源码</a></figcaption></p>
<pre class="highlight conf"><code><span class="n">input</span> {
  <span class="c">#beats {
</span>  <span class="c">#  port =&gt; '5044'
</span>  <span class="c">#}
</span>
  <span class="n">file</span> {
    <span class="n">path</span> =&gt; <span class="s1">'/path/to/log/production.log'</span>
    <span class="n">codec</span> =&gt; <span class="n">multiline</span> {
      <span class="n">pattern</span> =&gt; <span class="s2">"-- : Started "</span>
      <span class="n">negate</span> =&gt; <span class="n">true</span>
      <span class="n">what</span> =&gt; <span class="s1">'previous'</span>
    }
  }
}

<span class="n">filter</span> {
  <span class="n">grok</span> {
    <span class="n">patterns_dir</span> =&gt; <span class="s1">'../grok-patterns'</span>
    <span class="n">match</span> =&gt; { <span class="s2">"message"</span> =&gt; <span class="s2">"%{RAILS4}"</span> }
  }

  <span class="n">date</span> {
    <span class="n">match</span> =&gt; [<span class="s1">'timestamp'</span>, <span class="s1">'yyyy-MM-dd HH:mm:ss Z'</span>]
    <span class="n">remove_field</span> =&gt; [<span class="s1">'timestamp'</span>]
  }

  <span class="n">geoip</span> {
    <span class="n">source</span> =&gt; <span class="s1">'clientip'</span>
    <span class="c">#fields =&gt;  ["city_name", "country_code2", "country_name", "latitude", "longitude", "region_name"]
</span>  }
}

<span class="n">output</span> {
  <span class="n">stdout</span> {
    <span class="n">codec</span> =&gt; <span class="n">rubydebug</span>
  }

  <span class="n">elasticsearch</span> {
    <span class="n">hosts</span> =&gt; [<span class="s1">'127.0.0.1:9200'</span>]
  }
}

</code></pre>

<p></firgure></p>

<h2>延伸阅读</h2>

<p>参考 <a href="http://kibana.logstash.es/content/">ELKstack 中文指南</a></p>
</div><div class="post-copyright">除非注明，文章均为 <a href="http://wongyouth.com">wongyouth</a> 原创，转载请注明本文地址：<a href="http://wongyouth.com/blog/2016/02/24/elk-with-rails-log-analytics/">http://wongyouth.com/blog/2016/02/24/elk-with-rails-log-analytics/</a></div><ul class="pager"><li><a href="/blog/2015/10/30/deploy-redmine-with-docker/">&laquo; 上一篇 &laquo;</a></li><li><a href="/blog/2016/12/30/enhenced-ftp-tool-comparision/">&raquo; 下一篇 &raquo;</a></li></ul></section>  <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="/blog/2016/02/24/elk-with-rails-log-analytics/" data-title="ELK 套件分析Rails日志" data-url="http://wongyouth.github.io/blog/2016/02/24/elk-with-rails-log-analytics/"></div>
  <!-- 多说评论框 end -->

</article>


        </div>
        <div class="col-sm-4 col-md-3">
          <ul class="list-group">
  <li class="list-group-item list-group-item-success">
    关于我
  </li>

  <li class="list-group-item profile">
    <img src="http://tp1.sinaimg.cn/1429798952/50/5627311745/1" alt="破而后立">
    系统架构师<br>
    全栈式 Rails 开发者<br>
    最近折腾了一些前端框架<br>
    关注 Web，移动，创业<br>
    <div class="social">
      <a class="wechat" href="/images/social/my_wechat-bcc4527b.png" rel='facebox' title="Wechat">微信</a>
      <a class="github" href="https://github.com/wongyouth" title="GitHub">GitHub</a>
      <a class="twitter" href="http://twitter.com/wongyouth" title="Twitter">Twitter</a>
      <a class="rss" href="/atom.xml" title="RSS">RSS</a>
    </div>
  </li>
</ul>

<ul class="list-group">
  <li class="list-group-item list-group-item-success">
    近期文章
  </li>

    <li class="list-group-item">
      <a href="/blog/2016/12/30/enhenced-ftp-tool-comparision/">Ftp 增强工具比较</a> <span class="text-muted">12-30</span>
    </li>
    <li class="list-group-item">
      <a href="/blog/2016/02/24/elk-with-rails-log-analytics/">ELK 套件分析Rails日志</a> <span class="text-muted">02-24</span>
    </li>
    <li class="list-group-item">
      <a href="/blog/2015/10/30/deploy-redmine-with-docker/">使用 Docker 来安装 Redmine 并结合 gitolite 使用</a> <span class="text-muted">10-30</span>
    </li>
    <li class="list-group-item">
      <a href="/blog/2015/07/02/use-docker-with-rails/">与 Docker 一起使用 Rails</a> <span class="text-muted">07-02</span>
    </li>
    <li class="list-group-item">
      <a href="/blog/2015/01/09/use-gpg-to-encrypt-your-data/">使用 GPG 加密数据</a> <span class="text-muted">01-09</span>
    </li>
</ul>

<ul class="list-group">
  <li class="list-group-item list-group-item-success">
    近期评论
  </li>
  <li class="list-group-item recent-comments">
    <ul class="ds-recent-comments" data-num-items="5" data-show-avatars="1" data-show-time="1" data-show-admin="1" data-excerpt-length="70"></ul>
  </li>
</ul>

<ul class="list-group">
  <li class="list-group-item list-group-item-success">
    标签云
  </li>

  <li class="list-group-item" id="tagcloud">
      <a rel="3" href="/blog/tags/博客/">博客</a>
      <a rel="9" href="/blog/tags/ruby/">Ruby</a>
      <a rel="5" href="/blog/tags/rails/">Rails</a>
      <a rel="6" href="/blog/tags/server/">Server</a>
      <a rel="6" href="/blog/tags/git/">Git</a>
      <a rel="1" href="/blog/tags/淘宝/">淘宝</a>
      <a rel="9" href="/blog/tags/运维/">运维</a>
      <a rel="4" href="/blog/tags/db/">DB</a>
      <a rel="2" href="/blog/tags/postgresql/">Postgresql</a>
      <a rel="1" href="/blog/tags/mongodb/">Mongodb</a>
      <a rel="1" href="/blog/tags/nosql/">Nosql</a>
      <a rel="1" href="/blog/tags/vim/">Vim</a>
      <a rel="1" href="/blog/tags/redmine/">Redmine</a>
      <a rel="1" href="/blog/tags/项目管理/">项目管理</a>
      <a rel="1" href="/blog/tags/ssl/">SSL</a>
      <a rel="2" href="/blog/tags/lvm/">LVM</a>
      <a rel="1" href="/blog/tags/dns/">DNS</a>
      <a rel="1" href="/blog/tags/bind9/">Bind9</a>
      <a rel="1" href="/blog/tags/nfs/">NFS</a>
      <a rel="2" href="/blog/tags/mac/">Mac</a>
      <a rel="1" href="/blog/tags/chef/">Chef</a>
      <a rel="1" href="/blog/tags/自媒体/">自媒体</a>
      <a rel="2" href="/blog/tags/数据/">数据</a>
      <a rel="1" href="/blog/tags/中国城市/">中国城市</a>
      <a rel="3" href="/blog/tags/数据库/">数据库</a>
      <a rel="1" href="/blog/tags/postgresql/">PostgreSQL</a>
      <a rel="1" href="/blog/tags/安全/">安全</a>
      <a rel="2" href="/blog/tags/docker/">Docker</a>
      <a rel="1" href="/blog/tags/logstash/">Logstash</a>
      <a rel="1" href="/blog/tags/ftp/">ftp</a>
  </li>
</ul>

<ul class="list-group">
  <li class="list-group-item list-group-item-success">
    年份
  </li>

    <li class="list-group-item">
      <span class="badge">2</span>
      <a href="/blog/2016/">2016</a>
    </li>
    <li class="list-group-item">
      <span class="badge">3</span>
      <a href="/blog/2015/">2015</a>
    </li>
    <li class="list-group-item">
      <span class="badge">10</span>
      <a href="/blog/2014/">2014</a>
    </li>
    <li class="list-group-item">
      <span class="badge">8</span>
      <a href="/blog/2013/">2013</a>
    </li>
    <li class="list-group-item">
      <span class="badge">11</span>
      <a href="/blog/2012/">2012</a>
    </li>
</ul>

<ul class="list-group">
  <li class="list-group-item">
    <div id="qrcode"></div>
    <div>使用手机阅读或分享至微信朋友圈</div>
  </li>
</ul>

        </div>
      </div>
    </div>

    <div id="footer" class="text-center">
      <div>
        ©2014 <a href="http://wongyouth.com">http://wongyouth.com</a>
        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1000394755'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1000394755%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>

        <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F84b5475b333b745a8ca4850a4852fe67' type='text/javascript'%3E%3C/script%3E"));
</script>


      </div>
      <div class="credit">Powered by <a href="http://middlemanapp.com">Middleman</a></div>
    </div>

    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
    (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
    function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
    e=o.createElement(i);r=o.getElementsByTagName(i)[0];
    e.src='//www.google-analytics.com/analytics.js';
    r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
    ga('create','UA-30466888-1');ga('send','pageview');
</script>


    <script src="../../../../../javascripts/all-7bcf5a86.js" type="text/javascript"></script>
        <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":["mshare","weixin","tsina","qzone","tqq","renren","kaixin001"],"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"2","bdPos":"right","bdTop":"150"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"wongyouth"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0] 
           || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
        </script>
      <!-- 多说公共JS代码 end -->

    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.js" type="text/javascript"></script>
    <![endif]-->
  </body>
</html>
