<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="keywords" content="wongyouth, Ryan Wang, 王永志, Rails, Javascript, Web, 移动, 产品, 创业">
    <meta name="description" content="王永志(Ryan Wang)的个人博客，关注Web，移动，产品，创业。">
    <meta name="baidu-site-verification" content="whKGC9t0PW" />
    <title>Using LVM striped logical volumn - 王永志的独立博客</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />

    <link href="../../../../../stylesheets/all-6c32d234.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <!--[if lt IE 7]>
      <p class="browsehappy">你的浏览器版本过于<strong>陈旧</strong>。请<a href="http://browsehappy.com/">更新你的浏览器</a> 以提升访问体验。</p>
    <![endif]-->
    <header class="navbar navbar-default" role="navigation">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">王永志的独立博客</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li><a href="/blog/archives">归档</a></li>
            <li><a href="/blog/topics/技术">技术</a></li>
            <li><a href="/blog/topics/运营">运营</a></li>
          </ul>
          <form class="navbar-form navbar-left" role="search" action='http://www.google.com.hk/search' id="search">
            <div class="form-group">
              <input type="hidden" name='sitesearch' value='wongyouth.com'>
              <input type="text" name='q' class="form-control" placeholder='搜索'>
            </div>
          </form>
        </div><!-- /.navbar-collapse -->

      </div><!-- /.container -->
    </header>

    <div class="container">
      <div class="row">
        <div id="main" role="main" class="col-sm-8 col-md-9">
            <article><section class="post"><h1 class="post-title"><i class="glyphicon glyphicon-info-sign"></i>Using LVM striped logical volumn</h1><div class="meta text-muted">
  <div class="date">
    <i class="glyphicon glyphicon-calendar"></i>
    <abbr class="timeago" title="2014-09-04T17:47:00+08:00">2014-09-04 17:47</abbr>
  </div>
  <div class="comments">
    <i class="glyphicon glyphicon-comment"></i>
    <span class="ds-thread-count" data-thread-key="/blog/2014/09/04/using-lvm-striped-logical-volumn/" data-count-type="comments"></span>
  </div>
  <div class="tags">
    <i class="glyphicon glyphicon-tags"></i>
    <a href="/blog/tags/server/">Server</a>, <a href="/blog/tags/lvm/">LVM</a>, <a href="/blog/tags/运维/">运维</a>
  </div>
</div>

<div class="post-content"><p>之前写过一篇关于 LVM 的<a href="/blog/2013/01/30/use-lvm-with-your-server/">博文</a>。
今天要说的是有关 LVM 的一个应用。</p>

<h1>原理</h1>

<p>当系统需要很多读写操作，需要更高效率的磁盘读写能力，完全升级磁盘等级会没有太多意义。
因为无论多好的磁盘读写能力，总会达到峰顶。</p>

<p>这时候我们需要另一种的解法。</p>

<p>挂载更多的磁盘到一个目录，这样写到一个磁盘的数据会分散到各个磁盘中，
这样子理论上可以达到无限扩展。</p>

<p>能够实现这个技术的，有RAID0, LVM Stripe。这里我只说LVM。</p>

<h1>操作</h1>

<h2>确认 vg 所有 物理盘数量</h2>
<pre class="highlight plaintext"><code>jxb@pg2:~$ sudo vgs
  VG   #PV #LV #SN Attr   VSize  VFree
  db     3   1   0 wz--n- 59.99g 1008.00m
</code></pre>

<p>这里可以确认 PV 的数量是 3 个。</p>

<h2>生成 <code>Stripe</code> 逻辑盘</h2>
<pre class="highlight plaintext"><code># lvcreate -n pg1 -L 59G -i 3 db
</code></pre>

<p>生成由 3 个物理盘组成的 <code>striped</code> 的逻辑盘</p>

<h2>查看逻辑盘是否是 <code>Stripe</code> 盘</h2>
<pre class="highlight plaintext"><code>jxb@db:~$ sudo lvs --segments
[sudo] password for jxb:
  LV   VG   Attr   #Str Type    SSize
  pg1  db   -wi-ao    3 striped 59.00g
</code></pre>

<p>这是一个由3个盘组成的 <code>Stripe</code> 盘。总共的容量是59G。</p>

<h1>扩展Striped逻辑盘</h1>

<p>扩展Striped逻辑盘的时候需要准备与生成时相同数量的物理盘，我们现在用了3个盘，所以一定要准备3个物理盘</p>
<pre class="highlight plaintext"><code>jxb@pg2:~$ sudo pvcreate /dev/xvdg
  Physical volume "/dev/xvdg" successfully created
jxb@pg2:~$ sudo vgextend db /dev/xvdg
  Volume group "db" successfully extended
jxb@pg2:~$ sudo lvextend db/pg1 -L 70G
  Using stripesize of last segment 4.00 KiB
  Rounding size (17920 extents) down to stripe boundary size for segment (17919 extents)
  Extending logical volume pg1 to 70.00 GiB
  Insufficient free space: 2814 extents needed, but only 2811 available
</code></pre>

<p>可以看到只有一个物理盘的时候无法扩展逻辑盘</p>
<pre class="highlight plaintext"><code>jxb@pg2:~$ sudo pvcreate /dev/xvdi
  Physical volume "/dev/xvdi" successfully created
jxb@pg2:~$ sudo pvcreate /dev/xvdh
  Physical volume "/dev/xvdh" successfully created
jxb@pg2:~$ sudo vgextend db /dev/xvdi
  Volume group "db" successfully extended
jxb@pg2:~$ sudo vgextend db /dev/xvdh
  Volume group "db" successfully extended
jxb@pg2:~$ vgs
  WARNING: Running as a non-root user. Functionality may be unavailable.
  No volume groups found
jxb@pg2:~$ sudo vgs
  VG   #PV #LV #SN Attr   VSize  VFree
  db     6   1   0 wz--n- 89.98g 30.97g
jxb@pg2:/u$ sudo lvextend -l+100%free db/pg1
  Using stripesize of last segment 4.00 KiB
  Extending logical volume pg1 to 89.98 GiB
  Logical volume pg1 successfully resized
</code></pre>

<h2>查看 <code>Stripe</code>  逻辑盘信息</h2>
<pre class="highlight plaintext"><code>jxb@pg2:/u$ sudo lvs --segments
  LV   VG   Attr   #Str Type    SSize
  pg1  db   -wi-ao    3 striped 59.99g
  pg1  db   -wi-ao    3 striped 29.99g
</code></pre>

<h2>调整逻辑盘大小</h2>

<p>调整前已经使用了 76%</p>
<pre class="highlight plaintext"><code>jxb@pg2:/u$ df -h
Filesystem          Size  Used Avail Use% Mounted on
/dev/mapper/db-pg1   59G   43G   14G  76% /u
</code></pre>

<p>执行调整操作</p>
<pre class="highlight plaintext"><code>jxb@pg2:/u$ sudo resize2fs /dev/mapper/db-pg1
resize2fs 1.42 (29-Nov-2011)
Filesystem at /dev/mapper/db-pg1 is mounted on /u; on-line resizing required
old_desc_blocks = 4, new_desc_blocks = 6
Performing an on-line resize of /dev/mapper/db-pg1 to 23586816 (4k) blocks.
The filesystem on /dev/mapper/db-pg1 is now 23586816 blocks long.
</code></pre>

<p>调整后 降为 51%</p>
<pre class="highlight plaintext"><code>jxb@pg2:/u$ df -h
Filesystem          Size  Used Avail Use% Mounted on
/dev/mapper/db-pg1   90G   43G   43G  51% /u
</code></pre>

<p>到此 Stripe 逻辑盘扩展成功</p>

<p>注意事项：<code>resize2fs</code> 在 Kernel2.6 之前是需要 <code>umount</code> 盘之后才可操作，执行该项操作做好数据备份工作。</p>

<h2>延伸阅读</h2>

<p><a title="生成Stripe逻辑盘" href="http://tldp.org/HOWTO/LVM-HOWTO/recipethreescsistripe.html">生成Stripe逻辑盘</a>,
<a title="迁移LVM硬盘到别的主机上" href="http://tldp.org/HOWTO/LVM-HOWTO/recipemovevgtonewsys.html">迁移LVM硬盘到别的主机上</a></p>
</div><div class="post-copyright">除非注明，文章均为 <a href="http://wongyouth.com">wongyouth</a> 原创，转载请注明本文地址：<a href="http://wongyouth.com/blog/2014/09/04/using-lvm-striped-logical-volumn/">http://wongyouth.com/blog/2014/09/04/using-lvm-striped-logical-volumn/</a></div><ul class="pager"><li><a href="/blog/2014/07/16/when-activerecord-is-not-enough/">&laquo; 上一篇 &laquo;</a></li><li><a href="/blog/2014/09/05/configure-postgresql-master-slave-replication/">&raquo; 下一篇 &raquo;</a></li></ul></section>  <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="/blog/2014/09/04/using-lvm-striped-logical-volumn/" data-title="Using LVM striped logical volumn" data-url="http://wongyouth.github.io/blog/2014/09/04/using-lvm-striped-logical-volumn/"></div>
  <!-- 多说评论框 end -->

</article>


        </div>
        <div class="col-sm-4 col-md-3">
          <ul class="list-group">
  <li class="list-group-item list-group-item-success">
    关于我
  </li>

  <li class="list-group-item profile">
    <img src="http://tp1.sinaimg.cn/1429798952/50/5627311745/1" alt="破而后立">
    系统架构师<br>
    全栈式 Rails 开发者<br>
    最近折腾了一些前端框架<br>
    关注 Web，移动，创业<br>
    <div class="social">
      <a class="wechat" href="/images/social/my_wechat-bcc4527b.png" rel='facebox' title="Wechat">微信</a>
      <a class="github" href="https://github.com/wongyouth" title="GitHub">GitHub</a>
      <a class="twitter" href="http://twitter.com/wongyouth" title="Twitter">Twitter</a>
      <a class="rss" href="/atom.xml" title="RSS">RSS</a>
    </div>
  </li>
</ul>

<ul class="list-group">
  <li class="list-group-item list-group-item-success">
    近期文章
  </li>

    <li class="list-group-item">
      <a href="/blog/2016/12/30/enhenced-ftp-tool-comparision/">Ftp 增强工具比较</a> <span class="text-muted">12-30</span>
    </li>
    <li class="list-group-item">
      <a href="/blog/2016/02/24/elk-with-rails-log-analytics/">ELK 套件分析Rails日志</a> <span class="text-muted">02-24</span>
    </li>
    <li class="list-group-item">
      <a href="/blog/2015/10/30/deploy-redmine-with-docker/">使用 Docker 来安装 Redmine 并结合 gitolite 使用</a> <span class="text-muted">10-30</span>
    </li>
    <li class="list-group-item">
      <a href="/blog/2015/07/02/use-docker-with-rails/">与 Docker 一起使用 Rails</a> <span class="text-muted">07-02</span>
    </li>
    <li class="list-group-item">
      <a href="/blog/2015/01/09/use-gpg-to-encrypt-your-data/">使用 GPG 加密数据</a> <span class="text-muted">01-09</span>
    </li>
</ul>

<ul class="list-group">
  <li class="list-group-item list-group-item-success">
    近期评论
  </li>
  <li class="list-group-item recent-comments">
    <ul class="ds-recent-comments" data-num-items="5" data-show-avatars="1" data-show-time="1" data-show-admin="1" data-excerpt-length="70"></ul>
  </li>
</ul>

<ul class="list-group">
  <li class="list-group-item list-group-item-success">
    标签云
  </li>

  <li class="list-group-item" id="tagcloud">
      <a rel="3" href="/blog/tags/博客/">博客</a>
      <a rel="9" href="/blog/tags/ruby/">Ruby</a>
      <a rel="5" href="/blog/tags/rails/">Rails</a>
      <a rel="6" href="/blog/tags/server/">Server</a>
      <a rel="6" href="/blog/tags/git/">Git</a>
      <a rel="1" href="/blog/tags/淘宝/">淘宝</a>
      <a rel="9" href="/blog/tags/运维/">运维</a>
      <a rel="4" href="/blog/tags/db/">DB</a>
      <a rel="2" href="/blog/tags/postgresql/">Postgresql</a>
      <a rel="1" href="/blog/tags/mongodb/">Mongodb</a>
      <a rel="1" href="/blog/tags/nosql/">Nosql</a>
      <a rel="1" href="/blog/tags/vim/">Vim</a>
      <a rel="1" href="/blog/tags/redmine/">Redmine</a>
      <a rel="1" href="/blog/tags/项目管理/">项目管理</a>
      <a rel="1" href="/blog/tags/ssl/">SSL</a>
      <a rel="2" href="/blog/tags/lvm/">LVM</a>
      <a rel="1" href="/blog/tags/dns/">DNS</a>
      <a rel="1" href="/blog/tags/bind9/">Bind9</a>
      <a rel="1" href="/blog/tags/nfs/">NFS</a>
      <a rel="2" href="/blog/tags/mac/">Mac</a>
      <a rel="1" href="/blog/tags/chef/">Chef</a>
      <a rel="1" href="/blog/tags/自媒体/">自媒体</a>
      <a rel="2" href="/blog/tags/数据/">数据</a>
      <a rel="1" href="/blog/tags/中国城市/">中国城市</a>
      <a rel="3" href="/blog/tags/数据库/">数据库</a>
      <a rel="1" href="/blog/tags/postgresql/">PostgreSQL</a>
      <a rel="1" href="/blog/tags/安全/">安全</a>
      <a rel="2" href="/blog/tags/docker/">Docker</a>
      <a rel="1" href="/blog/tags/logstash/">Logstash</a>
      <a rel="1" href="/blog/tags/ftp/">ftp</a>
  </li>
</ul>

<ul class="list-group">
  <li class="list-group-item list-group-item-success">
    年份
  </li>

    <li class="list-group-item">
      <span class="badge">2</span>
      <a href="/blog/2016/">2016</a>
    </li>
    <li class="list-group-item">
      <span class="badge">3</span>
      <a href="/blog/2015/">2015</a>
    </li>
    <li class="list-group-item">
      <span class="badge">10</span>
      <a href="/blog/2014/">2014</a>
    </li>
    <li class="list-group-item">
      <span class="badge">8</span>
      <a href="/blog/2013/">2013</a>
    </li>
    <li class="list-group-item">
      <span class="badge">11</span>
      <a href="/blog/2012/">2012</a>
    </li>
</ul>

<ul class="list-group">
  <li class="list-group-item">
    <div id="qrcode"></div>
    <div>使用手机阅读或分享至微信朋友圈</div>
  </li>
</ul>

        </div>
      </div>
    </div>

    <div id="footer" class="text-center">
      <div>
        ©2014 <a href="http://wongyouth.com">http://wongyouth.com</a>
        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1000394755'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1000394755%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>

        <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F84b5475b333b745a8ca4850a4852fe67' type='text/javascript'%3E%3C/script%3E"));
</script>


      </div>
      <div class="credit">Powered by <a href="http://middlemanapp.com">Middleman</a></div>
    </div>

    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
    (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
    function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
    e=o.createElement(i);r=o.getElementsByTagName(i)[0];
    e.src='//www.google-analytics.com/analytics.js';
    r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
    ga('create','UA-30466888-1');ga('send','pageview');
</script>


    <script src="../../../../../javascripts/all-7bcf5a86.js" type="text/javascript"></script>
        <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":["mshare","weixin","tsina","qzone","tqq","renren","kaixin001"],"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"2","bdPos":"right","bdTop":"150"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"wongyouth"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0] 
           || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
        </script>
      <!-- 多说公共JS代码 end -->

    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.js" type="text/javascript"></script>
    <![endif]-->
  </body>
</html>
